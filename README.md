# VK Group Bot
Думаю, что многие из нас сталкивались со следующей проблемой: много и даже очень много мусора в новостной ленте ВК, от которого не может спасти т.н. *"Умная лента"*. А вы всё пролистываете и пролистываете это нескончаемую ленту ради немногих действительно полезных / интересных / смешных постов, не так ли? Нельзя ли подписаться лишь на одну группу, а не 50, и получать только лучшие посты в новостях, да и в принципе тратить своё время на что-то полезное, а не бесконечное листание? Да, можно, и именно для этого и предназначен данный бот.
Основная идея - Бот ежедневно сам определяет какие посты были лучшими за день во всех интересующих вас группах и выкладывает нужное вам количество в группу.
# Оглавление

 1. [Используемые технологии](#Используемые-технологии)
 2. [Принцип работы](#Принцип-работы)
	 1. [Устройство класса Post](#Устройство-класса-post)
	 2. [Как всё работает](#Как-всё-работает)
 3. [Установка и настройка](#Установка-и-настройка)
	 1. [Скачивание](#Скачивание)
	 2. [Создание Standalone приложения](#Создание-standalone-приложения)
	 3. [Получение access token](#Получение-access-token)
	 4. [Создание группы](#Создание-группы)
	 5. [Выбор нужных групп](#Выбор-нужных-групп)
	 6. [Автоматический запуск Бота](#Автоматический-запуск-Бота)
 4. [Дополнительно](#Дополнительно)
	 1. [Несколько групп](#Несколько-групп)
	 2. [Параметры в конфигурационном файле](#Параметры-в-конфигурационном-файле)

# [Используемые технологии](#Оглавление)
- VK API - рекомендую познакомиться поближе для более полного понимания принципов работы бота, начать можно [отсюда](https://vk.com/dev/first_guide).
- Python библиотеки json, requests
# [Принцип работы](#Оглавление)
Тут ничего разжёвываться не будет, в отличии от следующего пункта.
Всё начинается с того, что Бот читает конфиг, проверяет на наличие ошибок, если находит их, то ~~посылает~~ пишет в чём проблема и завершает работу. Если всё хорошо, то далее он делает следующие вещи для всех групп.
## [Устройство класса Post](#Оглавление)
У каждого поста есть информация о том какой группе он принадлежит, какое у группы имя, сколько участников, информация о метриках и о медиа данных, которые в нём содержатся. Вообще у каждого медиа файла в VK есть ID владельца и ID самого файла. Информация об этом всём хранится в Посте. 
## [Как всё работает](#Оглавление)
Для начала, получаем все так называемые т.н. короткие имена групп в ссылках, получаем их айдишники, названия (они нам пригодятся для логирование) и количество участников. Потом из каждой группы берём 100 последних постов (100 постов можно получить максимально одним запросом и там 100% будут содержаться все вчерашние посты), выбираем из них те, в которых нет рекламы и прочей шелухи, потом выбираем вчерашние.  Для каждого поста у нас есть 3 основным метрики: лайки, репосты и просмотры. Мы дополняем их отношением лайков к просмотрам и репостов к просмотрам (то есть сколько людей из тех, кто увидели пост, лайкнули и или репостнули его), то бишь объединяем 3 матрики в 2 новые и более релевантные. Далее мы выбираем лучшим постом вчерашнего дня тупо тот пост, который собрал больше всего лайков - это наилучший подход, доказано эмпирическим путём.

У нас собраны по одному лучшему вчерашнему посту почти со всех групп. Почти, потому как где-то могли и не выкладывать посты вчера. Теперь мы имеем массив этих постов и для выбора того количества постов, которые мы хотим выкладывать в день,  нам необходимо их отсортировать по годности. Это - камень преткновения, и именно об него бились мои алгоритмы выбора самых "годных" постов. В итоге был вычислен следующий способ:

 1. Берём наш массив постов, копируем и сортируем по метрике "лайк за просмотр" в порядке возрастания;
 2. Берём наш массив постов, копируем и сортируем по метрике "репост за просмотр" в порядке возрастания;

Вот теперь-то мы и готовы к тому, чтобы выявить меру годности постов.

 3. Для каждого поста мы смотрим сумму индексов, на которых находится пост в массивах из п. 1 и 2. Так как те массивы отсортированы по убыванию, то пост с наибольшим суммарным индексом наиболее интересен публике.;
 4. Сортируем наш изначальный массив по суммарному индексу из прошлого пункта.

Спрашивается, а почему бы тоже не брать тупо по лайкам, или тупо по репостам? А вот почему: 

 - "лайкни или котик умрёт" 
 - "репост, если тоже любишь маму"

Примеры, конечно, образные... Или нет??? Нет, не образные, используя комбинирование наших двух релевантных метрик мы получаем наилучшую метрику, которая будет защищать нас и нашу группу от постов подобного уровня. Ну и в любом случае, глупо полагаться лишь на что-то одно. А так мы получаем лучшие посты. 

Ну получили мы отсортированный массив по годности, и дальше просто обрезаем этот массив... Нет, не просто. Нужно создать эффект случайности, именно поэтому мы не берём просто `number_of_posts` постов, нет, мы берём `number_of_posts * scatter` постов, потом их перемешиваем и уже потом обрезаем до размеров `number_of_posts`.

Далее мы делаем `number_of_posts` отложенных записей в нашу группу с равными промежутками. Но только если не вмешается ошибка, связанная с тем, что длина запроса слишком большая и нам сервер выкидывает exception. Такое бывает, если вы пытаетесь запостить, например, очень длинный анекдот. А длина запроса, к сожалению, не резиновая, думаю, это один из многих способов защиты от дудоса серверов VK. Но прога из-за этой ошибки не летит, а просто пишет, что что-то случилось.

Потом мы логируем всю информацию о выложенных постах, а также интересные графики. Они стали фичей исключительно из-за того, что во время опытов по подбору алгоритма определения годности постов мне нужно было видеть не просто цифры с метрик, а красиво представленные значения метрик по всем постам, чтобы "зрить в корень". Логи, кстати, пишутся без единого вмешательства человека. Сама и папочка сделается, и логи по разным группам не потеряются.

Всё.

# [Установка и настройка](#Оглавление)
## [Скачивание](#Оглавление)
Скачайте и распакуйте в любом удобном вам месте.
Подразумевается, что у вас уже установлен Python 3.
## [Создание Standalone приложения](#Оглавление)
Для начала вам нужно создать своё приложение ВК:
[Ваши приложения](https://vk.com/apps?act=manage) -> "Создать приложение" -> в списке "Платформа" выбираете "Standalone-приложение", называете как вам угодно -> ничего не настраиваете, снова переходите в [ваши приложения](https://vk.com/apps?act=manage) -> "Редактировать" -> выбираете вкладку "Настройки" -> вам нужно только "ID приложения".
***Вы создали приложение, которое необходимо для создания ключа доступа.***
## [Получение access token](#Оглавление)
В папке с ботом создайте пустой текстовый файл `access_token.txt`.
В папке с ботом лежит конфигурационный файл `config.json`, откройте его и скопируйте значение поля `"token"` и вставьте его в адресную строку браузера, должно получиться что-то такое:

    https://oauth.vk.com/authorize?client_id=6289595&display=page&redirect_uri=https://oauth.vk.com/blank.html&scope=friends,photos,audio,video,status,wall,offline,groups,messages,manage&response_type=token&v=5.74

В ссылке есть следующий элемент: `client_id=6289595`. Замените цифры на ID вашего приложения, который вы получили из предыдущего пункта. Пока не запускайте страницу. Пройдите [сюда](https://vk.com/dev/versions) и посмотрите какая версия VK API последняя. В конце ссылки есть `v=5.74`. Опять же, эти цифры нужно заменить на те, которые вы увидели, перейдя по ссылке. После замены ID и версии VK API в адресе запустите страницу. Вы будете перенаправлены на страницу, в которой ваше приложение запросит доступ к некоторым возможностям вашего аккаунта -> нажимаете "Разрешить" -> вас перенаправляют на страницу, в которой будет написано 

> Пожалуйста, не копируйте данные из адресной строки для сторонних
> сайтов. Таким образом Вы можете потерять доступ к Вашему аккаунту.

Вы должны посмотреть на адрес, на который вас перенаправило, там вы увидите такой элемент: `access_token=...&`. На месте "..." должно быть много латинских букв вперемешку с цифрами. Скопируйте все символы, которые стоят между `=` и `&` и вставьте их в недавно созданный `access_token.txt`.
***Вы получили ключ доступа, с помощью которого Бот будет работать с VK API.***
## [Создание группы](#Оглавление)
Можете использовать группу, которую вы создали ранее, либо создайте новую.
[Мои группы](https://vk.com/groups) -> "Создать сообщество" -> Можете выбрать тип сообщества "Тематическое сообщество", придумываете название, тематику и создаёте -> вы оказываетесь на странице настройки группы -> в "Адрес страницы" видите что-то вроде такого: `https://vk.com/public123456789`, копируете цифры после `public` и вставляете их в файл `config.json` в поле `"group_id"` вместо имеющегося там значения. Не забудьте обернуть в двойные кавычки. 
***Вы дали Боту ID вашей группы, в неё он будет выкладывать лучшие посты.***
## [Выбор нужных групп](#Оглавление)
Перейдите в раздел ссылки и добавьте все группы, которые вам интересны. Например, в той группе, в которой бот был использован впервые, в ссылках лежали около 80 групп с мемами и смешными картинками. 
***Вы выбрали группы, из которых Бот будет выбирать лучшие посты.***
## [Автоматический запуск Бота](#Оглавление)
Если у вас нет своего сервера, то вот как нужно поступить.
Подразумевается, что у вас Windows.
 1. В поиске Windows найдите "Планировщик заданий"
 2. Вкладка "Действие" -> "Создать задачу"
 3. Во вкладе "Общие" указываете Имя
 4. Во вкладке "Триггер" нажимаете "Создать", далее выбираете пункт "Ежедневно", дату в "Начать" можете оставить прежнюю, а время выбирайте во второй половине дня, лучше вечером, примерно в то время, когда у вас гарантированно включен компьютер. 
 5. Во вкладке "Действия" нажимаете "Создать", далее в поле "Программа или сценарий" вставьте путь до файла `launch.bat`, который лежит в папке `\src`. Например, `C:\Projects\VK-Group-Bot-v.2\src\launch.bat`. В "Рабочая папка" вставьте тоже самое, но без `\launch.bat`. Например, `C:\Projects\VK-Group-Bot-v.2\src`.
 6. Нажмите "Ок"

Если же у вас есть свой сервер, то вы сможете его настроить с помощью docker и [этого](https://hub.docker.com/r/kaylaweb/python-hello-world/~/dockerfile/).
Если же вы линуксоид, то вы наверняка всё сможете сделать сами, удачи!
***Вы сделали так, что Бот будет запускаться автоматически.***
# [Дополнительно](#Оглавление)
## [Несколько групп](#Оглавление)

Если вы хотите, чтобы у вас было, например, несколько групп на разные  тематики, вы легко можете расширить работу Бота для нескольких групп. Что для этого необходимо? 

 1. Повторение шагов [Создание группы](#Создание-группы) и [Выбор нужных групп](#Выбор-нужных-групп) для
    каждой из групп, которые вы хотите создать
 2. В файле `config.json` вам необходимо из поля `groups` скопировать всё, что содержится внутри фигурных скобок, включая сами скобки, поставить запятую после `}`, сделать перенос строки и вставить скопированное. 
Например: 
```
"groups":
[
	{
		"group_id": "158155713",
		"number_of_posts": 25,
		"repost_border": 5,
		"scatter": 1.4
	},
	{
		"group_id": "123456789",
		"number_of_posts": 25,
		"repost_border": 5,
		"scatter": 1.4
	}
],
```
 3. Сохранить конфигурационный файл
## [Параметры в конфигурационном файле](#Оглавление)
 - `"token"` - ссылка, необходимая для получение `access token`;
 - `"groups"` - массив групп, которые Бот должен вести;
	 - `"group_id"` - ID группы;
	 - `"number_of_posts"` - количество постов, которые Бот будет отбирать и выкладывать каждый день;
	 - `"repost_border"` - уровень репостов, ниже которых Бот будет пропускать посты и не рассматривать их как лучшие;
	 - `"scatter"` - коэффициент, с которым добавляется небольшая случайность в финальном отборе лучших постов. Не может быть ниже 1. Не рекомендуется присваивать значение больше 2;
 - `"vk_limit"` - внутренне ограничение VK по максимальному числу постов, которые можно откладывать в сутки.
 - `"version"` - версия VK API, рекомендуется поставить актуальную.